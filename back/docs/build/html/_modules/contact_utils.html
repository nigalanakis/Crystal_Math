

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>contact_utils &mdash; CrystalMath 2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=60dbed4a"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CrystalMath
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">src</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CrystalMath</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">contact_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for contact_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module: contact_utils.py</span>

<span class="sd">Batch utilities for computing and expanding intermolecular contacts and</span>
<span class="sd">hydrogen bonds using symmetry operations and mapping to fragment-level</span>
<span class="sd">descriptors.</span>

<span class="sd">Dependencies</span>
<span class="sd">------------</span>
<span class="sd">torch</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<div class="viewcode-block" id="compute_symmetric_contacts_batch">
<a class="viewcode-back" href="../api/contact_utils.html#contact_utils.compute_symmetric_contacts_batch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_symmetric_contacts_batch</span><span class="p">(</span>
        <span class="n">central_atom_label</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">contact_atom_label</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">central_atom_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">contact_atom_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">central_atom_frac_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">contact_atom_frac_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">lengths</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">strengths</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">in_los</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">symmetry_A</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">symmetry_T</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">symmetry_A_inv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">symmetry_T_inv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">cell_matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
            <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
            <span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expand intermolecular contacts by applying precomputed symmetry operations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    central_atom_label : List[List[str]]</span>
<span class="sd">        Original central-atom labels for each structure.</span>
<span class="sd">    contact_atom_label : List[List[str]]</span>
<span class="sd">        Original contact-atom labels for each structure.</span>
<span class="sd">    central_atom_idx : torch.LongTensor, shape (B, C)</span>
<span class="sd">        Central-atom indices per contact.</span>
<span class="sd">    contact_atom_idx : torch.LongTensor, shape (B, C)</span>
<span class="sd">        Contact-atom indices per contact.</span>
<span class="sd">    central_atom_frac_coords : torch.Tensor, shape (B, C, 3)</span>
<span class="sd">        Fractional coordinates of central atoms.</span>
<span class="sd">    contact_atom_frac_coords : torch.Tensor, shape (B, C, 3)</span>
<span class="sd">        Fractional coordinates of contact atoms.</span>
<span class="sd">    lengths : torch.Tensor, shape (B, C)</span>
<span class="sd">        Contact distances.</span>
<span class="sd">    strengths : torch.Tensor, shape (B, C)</span>
<span class="sd">        Contact strength metrics.</span>
<span class="sd">    in_los : torch.Tensor, shape (B, C)</span>
<span class="sd">        Line-of-sight contact mask.</span>
<span class="sd">    symmetry_A : torch.Tensor, shape (B, C, 3, 3)</span>
<span class="sd">        Symmetry rotation matrices.</span>
<span class="sd">    symmetry_T : torch.Tensor, shape (B, C, 3)</span>
<span class="sd">        Symmetry translation vectors.</span>
<span class="sd">    symmetry_A_inv : torch.Tensor, shape (B, C, 3, 3)</span>
<span class="sd">        Inverse symmetry rotation matrices.</span>
<span class="sd">    symmetry_T_inv : torch.Tensor, shape (B, C, 3)</span>
<span class="sd">        Inverse symmetry translation vectors.</span>
<span class="sd">    cell_matrix : torch.Tensor, shape (B, 3, 3)</span>
<span class="sd">        Real-space cell matrices for each structure.</span>
<span class="sd">    device : torch.device</span>
<span class="sd">        Device on which to perform computations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary of extended contact parameters:</span>
<span class="sd">          - inter_cc_central_atom : List[List[str]]</span>
<span class="sd">          - inter_cc_contact_atom : List[List[str]]</span>
<span class="sd">          - inter_cc_central_atom_idx : torch.LongTensor, shape (B, 2C)</span>
<span class="sd">          - inter_cc_contact_atom_idx : torch.LongTensor, shape (B, 2C)</span>
<span class="sd">          - inter_cc_central_atom_coords : torch.Tensor, shape (B, 2C, 3)</span>
<span class="sd">          - inter_cc_contact_atom_coords : torch.Tensor, shape (B, 2C, 3)</span>
<span class="sd">          - inter_cc_central_atom_frac_coords : torch.Tensor, shape (B, 2C, 3)</span>
<span class="sd">          - inter_cc_contact_atom_frac_coords : torch.Tensor, shape (B, 2C, 3)</span>
<span class="sd">          - inter_cc_length : torch.Tensor, shape (B, 2C)</span>
<span class="sd">          - inter_cc_strength : torch.Tensor, shape (B, 2C)</span>
<span class="sd">          - inter_cc_in_los : torch.Tensor, shape (B, 2C)</span>
<span class="sd">          - inter_cc_symmetry_A : torch.Tensor, shape (B, 2C, 3, 3)</span>
<span class="sd">          - inter_cc_symmetry_T : torch.Tensor, shape (B, 2C, 3)</span>
<span class="sd">          - inter_cc_symmetry_A_inv : torch.Tensor, shape (B, 2C, 3, 3)</span>
<span class="sd">          - inter_cc_symmetry_T_inv : torch.Tensor, shape (B, 2C, 3)</span>
<span class="sd">          - inter_cc_mask : torch.BoolTensor, shape (B, 2C)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Move fractional coords to device</span>
    <span class="n">central_atom_frac_coords</span> <span class="o">=</span> <span class="n">central_atom_frac_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">contact_atom_frac_coords</span> <span class="o">=</span> <span class="n">contact_atom_frac_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># Use fractional coords dtype to cast all other tensors</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">central_atom_frac_coords</span><span class="o">.</span><span class="n">dtype</span>

    <span class="c1"># Move and cast other tensors</span>
    <span class="n">central_atom_idx</span> <span class="o">=</span> <span class="n">central_atom_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">contact_atom_idx</span> <span class="o">=</span> <span class="n">contact_atom_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">lengths</span>          <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">strengths</span>        <span class="o">=</span> <span class="n">strengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">in_los</span>           <span class="o">=</span> <span class="n">in_los</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">symmetry_A</span>       <span class="o">=</span> <span class="n">symmetry_A</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">symmetry_T</span>       <span class="o">=</span> <span class="n">symmetry_T</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">symmetry_A_inv</span>   <span class="o">=</span> <span class="n">symmetry_A_inv</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">symmetry_T_inv</span>   <span class="o">=</span> <span class="n">symmetry_T_inv</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">cell_matrix</span>      <span class="o">=</span> <span class="n">cell_matrix</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">central_atom_frac_coords</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># 1) Compute reversed fractional coords</span>
    <span class="n">central_atom_frac_coords_rev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcij,bcj-&gt;bci&#39;</span><span class="p">,</span> <span class="n">symmetry_A_inv</span><span class="p">,</span> <span class="n">contact_atom_frac_coords</span><span class="p">)</span> <span class="o">+</span> <span class="n">symmetry_T_inv</span>
    <span class="n">contact_atom_frac_coords_rev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcij,bcj-&gt;bci&#39;</span><span class="p">,</span> <span class="n">symmetry_A_inv</span><span class="p">,</span> <span class="n">central_atom_frac_coords</span><span class="p">)</span> <span class="o">+</span> <span class="n">symmetry_T_inv</span>

    <span class="c1"># 2) Concatenate original + reversed coords</span>
    <span class="n">central_atom_frac_coords_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">central_atom_frac_coords</span><span class="p">,</span> <span class="n">central_atom_frac_coords_rev</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">contact_atom_frac_coords_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">contact_atom_frac_coords</span><span class="p">,</span> <span class="n">contact_atom_frac_coords_rev</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 3) Cartesian coords</span>
    <span class="n">central_atom_coords_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">central_atom_frac_coords_pre</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>
    <span class="n">contact_atom_coords_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">contact_atom_frac_coords_pre</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>

    <span class="c1"># 4) Duplicate metrics and indices</span>
    <span class="n">lengths_pre</span>          <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">lengths</span><span class="p">,</span> <span class="n">lengths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">strengths_pre</span>        <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">strengths</span><span class="p">,</span> <span class="n">strengths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">in_los_pre</span>           <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">in_los</span><span class="p">,</span> <span class="n">in_los</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">central_atom_idx_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">central_atom_idx</span><span class="p">,</span> <span class="n">contact_atom_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">contact_atom_idx_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">contact_atom_idx</span><span class="p">,</span> <span class="n">central_atom_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 5) Prepare extended symmetry matrices</span>
    <span class="n">symmetry_A_ext</span>     <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">symmetry_A</span><span class="p">,</span> <span class="n">symmetry_A_inv</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">symmetry_T_ext</span>     <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">symmetry_T</span><span class="p">,</span> <span class="n">symmetry_T_inv</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">symmetry_A_inv_ext</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">symmetry_A_inv</span><span class="p">,</span> <span class="n">symmetry_A</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">symmetry_T_inv_ext</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">symmetry_T_inv</span><span class="p">,</span> <span class="n">symmetry_T</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 6) Allocate zero-padded outputs</span>
    <span class="n">central_atom_frac_coords_ext</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">central_atom_frac_coords_pre</span><span class="p">)</span>
    <span class="n">contact_atom_frac_coords_ext</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">contact_atom_frac_coords_pre</span><span class="p">)</span>
    <span class="n">central_atom_coords_ext</span>      <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">central_atom_coords_pre</span><span class="p">)</span>
    <span class="n">contact_atom_coords_ext</span>      <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">contact_atom_coords_pre</span><span class="p">)</span>
    <span class="n">lengths_ext</span>                  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lengths_pre</span><span class="p">)</span>
    <span class="n">strengths_ext</span>                <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">strengths_pre</span><span class="p">)</span>
    <span class="n">in_los_ext</span>                   <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">in_los_pre</span><span class="p">)</span>
    <span class="n">central_atom_idx_ext</span>         <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">central_atom_idx_pre</span><span class="p">)</span>
    <span class="n">contact_atom_idx_ext</span>         <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">contact_atom_idx_pre</span><span class="p">)</span>

    <span class="c1"># 7) Pack valid contacts first</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
        <span class="n">nC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">lengths</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">nC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">orig_end</span> <span class="o">=</span> <span class="n">nC</span>
        <span class="n">rev_start</span> <span class="o">=</span> <span class="n">nC</span>
        <span class="n">rev_end</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nC</span>

        <span class="c1"># coords</span>
        <span class="n">central_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">central_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">central_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">central_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">contact_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">contact_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">contact_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">contact_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>

        <span class="n">central_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">central_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">central_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">central_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">contact_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">contact_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">contact_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">contact_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>

        <span class="c1"># metrics</span>
        <span class="n">lengths_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>           <span class="o">=</span> <span class="n">lengths_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">lengths_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>   <span class="o">=</span> <span class="n">lengths_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">strengths_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">strengths_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">strengths_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">strengths_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">in_los_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>            <span class="o">=</span> <span class="n">in_los_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">in_los_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>    <span class="o">=</span> <span class="n">in_los_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>

        <span class="c1"># indices</span>
        <span class="n">central_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">central_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">central_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">central_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">contact_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">contact_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">contact_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">contact_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>

    <span class="c1"># 8) Extend labels </span>
    <span class="n">central_atom_labels_ext</span> <span class="o">=</span> <span class="p">[</span><span class="n">orig</span> <span class="o">+</span> <span class="n">rev</span> <span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">rev</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">central_atom_label</span><span class="p">,</span> <span class="n">contact_atom_label</span><span class="p">)]</span>
    <span class="n">contact_atom_labels_ext</span> <span class="o">=</span> <span class="p">[</span><span class="n">orig</span> <span class="o">+</span> <span class="n">rev</span> <span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">rev</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contact_atom_label</span><span class="p">,</span> <span class="n">central_atom_label</span><span class="p">)]</span>
    
    <span class="c1"># 9) Calculate the contact mask</span>
    <span class="n">inter_cc_mask</span> <span class="o">=</span> <span class="n">lengths_ext</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;inter_cc_central_atom&quot;</span><span class="p">:</span>             <span class="n">central_atom_labels_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_contact_atom&quot;</span><span class="p">:</span>             <span class="n">contact_atom_labels_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_central_atom_idx&quot;</span><span class="p">:</span>         <span class="n">central_atom_idx_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_contact_atom_idx&quot;</span><span class="p">:</span>         <span class="n">contact_atom_idx_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_central_atom_coords&quot;</span><span class="p">:</span>      <span class="n">central_atom_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_contact_atom_coords&quot;</span><span class="p">:</span>      <span class="n">contact_atom_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_central_atom_frac_coords&quot;</span><span class="p">:</span> <span class="n">central_atom_frac_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_contact_atom_frac_coords&quot;</span><span class="p">:</span> <span class="n">contact_atom_frac_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_length&quot;</span><span class="p">:</span>                   <span class="n">lengths_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_strength&quot;</span><span class="p">:</span>                 <span class="n">strengths_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_in_los&quot;</span><span class="p">:</span>                   <span class="n">in_los_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_symmetry_A&quot;</span><span class="p">:</span>               <span class="n">symmetry_A_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_symmetry_T&quot;</span><span class="p">:</span>               <span class="n">symmetry_T_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_symmetry_A_inv&quot;</span><span class="p">:</span>           <span class="n">symmetry_A_inv_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_symmetry_T_inv&quot;</span><span class="p">:</span>           <span class="n">symmetry_T_inv_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_cc_mask&quot;</span><span class="p">:</span>                     <span class="n">inter_cc_mask</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="compute_symmetric_hbonds_batch">
<a class="viewcode-back" href="../api/contact_utils.html#contact_utils.compute_symmetric_hbonds_batch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_symmetric_hbonds_batch</span><span class="p">(</span>
        <span class="n">central_atom_label</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">hydrogen_atom_label</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">contact_atom_label</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">central_atom_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">hydrogen_atom_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">contact_atom_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">central_atom_frac_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">hydrogen_atom_frac_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">contact_atom_frac_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">lengths</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">angles</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">in_los</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">symmetry_A</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">symmetry_T</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">symmetry_A_inv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">symmetry_T_inv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">cell_matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
            <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
            <span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expand intermolecular H-bonds by applying precomputed symmetry operations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    central_atom_label : List[List[str]]</span>
<span class="sd">        Original donor-atom labels for each structure.</span>
<span class="sd">    hydrogen_atom_label : List[List[str]]</span>
<span class="sd">        Original hydrogen-atom labels for each structure.</span>
<span class="sd">    contact_atom_label : List[List[str]]</span>
<span class="sd">        Original acceptor-atom labels for each structure.</span>
<span class="sd">    central_atom_idx : torch.LongTensor, shape (B, H)</span>
<span class="sd">        Donor-atom indices per H-bond.</span>
<span class="sd">    hydrogen_atom_idx : torch.LongTensor, shape (B, H)</span>
<span class="sd">        Hydrogen-atom indices per H-bond.</span>
<span class="sd">    contact_atom_idx : torch.LongTensor, shape (B, H)</span>
<span class="sd">        Acceptor-atom indices per H-bond.</span>
<span class="sd">    central_atom_frac_coords : torch.Tensor, shape (B, H, 3)</span>
<span class="sd">        Fractional coordinates of donor atoms.</span>
<span class="sd">    hydrogen_atom_frac_coords : torch.Tensor, shape (B, H, 3)</span>
<span class="sd">        Fractional coordinates of hydrogen atoms.</span>
<span class="sd">    contact_atom_frac_coords : torch.Tensor, shape (B, H, 3)</span>
<span class="sd">        Fractional coordinates of acceptor atoms.</span>
<span class="sd">    lengths : torch.Tensor, shape (B, H)</span>
<span class="sd">        H-bond lengths.</span>
<span class="sd">    angles : torch.Tensor, shape (B, H)</span>
<span class="sd">        H-bond angles.</span>
<span class="sd">    in_los : torch.Tensor, shape (B, H)</span>
<span class="sd">        Line-of-sight flag per H-bond.</span>
<span class="sd">    symmetry_A : torch.Tensor, shape (B, H, 3, 3)</span>
<span class="sd">        Symmetry rotation matrices.</span>
<span class="sd">    symmetry_T : torch.Tensor, shape (B, H, 3)</span>
<span class="sd">        Symmetry translation vectors.</span>
<span class="sd">    symmetry_A_inv : torch.Tensor, shape (B, H, 3, 3)</span>
<span class="sd">        Inverse symmetry rotation matrices.</span>
<span class="sd">    symmetry_T_inv : torch.Tensor, shape (B, H, 3)</span>
<span class="sd">        Inverse symmetry translation vectors.</span>
<span class="sd">    cell_matrix : torch.Tensor, shape (B, 3, 3)</span>
<span class="sd">        Real-space cell matrices for each structure.</span>
<span class="sd">    device : torch.device</span>
<span class="sd">        Device on which to perform computations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary of extended H-bond parameters:</span>
<span class="sd">          - inter_hb_central_atom : List[List[str]]</span>
<span class="sd">          - inter_hb_hydrogen_atom : List[List[str]]</span>
<span class="sd">          - inter_hb_contact_atom : List[List[str]]</span>
<span class="sd">          - inter_hb_central_atom_idx : torch.LongTensor, shape (B, 2H)</span>
<span class="sd">          - inter_hb_hydrogen_atom_idx : torch.LongTensor, shape (B, 2H)</span>
<span class="sd">          - inter_hb_contact_atom_idx : torch.LongTensor, shape (B, 2H)</span>
<span class="sd">          - inter_hb_central_atom_coords : torch.Tensor, shape (B, 2H, 3)</span>
<span class="sd">          - inter_hb_hydrogen_atom_coords : torch.Tensor, shape (B, 2H, 3)</span>
<span class="sd">          - inter_hb_contact_atom_coords : torch.Tensor, shape (B, 2H, 3)</span>
<span class="sd">          - inter_hb_central_atom_frac_coords : torch.Tensor, shape (B, 2H, 3)</span>
<span class="sd">          - inter_hb_hydrogen_atom_frac_coords : torch.Tensor, shape (B, 2H, 3)</span>
<span class="sd">          - inter_hb_contact_atom_frac_coords : torch.Tensor, shape (B, 2H, 3)</span>
<span class="sd">          - inter_hb_length : torch.Tensor, shape (B, 2H)</span>
<span class="sd">          - inter_hb_angle : torch.Tensor, shape (B, 2H)</span>
<span class="sd">          - inter_hb_in_los : torch.Tensor, shape (B, 2H)</span>
<span class="sd">          - inter_hb_symmetry_A : torch.Tensor, shape (B, 2H, 3, 3)</span>
<span class="sd">          - inter_hb_symmetry_T : torch.Tensor, shape (B, 2H, 3)</span>
<span class="sd">          - inter_hb_symmetry_A_inv : torch.Tensor, shape (B, 2H, 3, 3)</span>
<span class="sd">          - inter_hb_symmetry_T_inv : torch.Tensor, shape (B, 2H, 3)</span>
<span class="sd">          - inter_hb_mask : torch.BoolTensor, shape (B, 2H)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Move fractional coords to device and get dtype</span>
    <span class="n">central_atom_frac_coords</span>  <span class="o">=</span> <span class="n">central_atom_frac_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">hydrogen_atom_frac_coords</span> <span class="o">=</span> <span class="n">hydrogen_atom_frac_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">contact_atom_frac_coords</span>  <span class="o">=</span> <span class="n">contact_atom_frac_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">central_atom_frac_coords</span><span class="o">.</span><span class="n">dtype</span>

    <span class="c1"># Move and cast other tensors</span>
    <span class="n">central_atom_idx</span>  <span class="o">=</span> <span class="n">central_atom_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">hydrogen_atom_idx</span> <span class="o">=</span> <span class="n">hydrogen_atom_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">contact_atom_idx</span>  <span class="o">=</span> <span class="n">contact_atom_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">lengths</span>           <span class="o">=</span> <span class="n">lengths</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">angles</span>            <span class="o">=</span> <span class="n">angles</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">in_los</span>            <span class="o">=</span> <span class="n">in_los</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">symmetry_A</span>        <span class="o">=</span> <span class="n">symmetry_A</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">symmetry_T</span>        <span class="o">=</span> <span class="n">symmetry_T</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">symmetry_A_inv</span>    <span class="o">=</span> <span class="n">symmetry_A_inv</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">symmetry_T_inv</span>    <span class="o">=</span> <span class="n">symmetry_T_inv</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">cell_matrix</span>       <span class="o">=</span> <span class="n">cell_matrix</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">central_atom_frac_coords</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># 1) Compute reversed fractional coords</span>
    <span class="n">central_atom_frac_coords_rev</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcij,bcj-&gt;bci&#39;</span><span class="p">,</span> <span class="n">symmetry_A_inv</span><span class="p">,</span> <span class="n">contact_atom_frac_coords</span><span class="p">)</span> <span class="o">+</span> <span class="n">symmetry_T_inv</span>
    <span class="n">hydrogen_atom_frac_coords_rev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcij,bcj-&gt;bci&#39;</span><span class="p">,</span> <span class="n">symmetry_A_inv</span><span class="p">,</span> <span class="n">hydrogen_atom_frac_coords</span><span class="p">)</span> <span class="o">+</span> <span class="n">symmetry_T_inv</span>
    <span class="n">contact_atom_frac_coords_rev</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bcij,bcj-&gt;bci&#39;</span><span class="p">,</span> <span class="n">symmetry_A_inv</span><span class="p">,</span> <span class="n">central_atom_frac_coords</span><span class="p">)</span> <span class="o">+</span> <span class="n">symmetry_T_inv</span>

    <span class="c1"># 2) Concatenate original + reversed coords</span>
    <span class="n">central_atom_frac_coords_pre</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">central_atom_frac_coords</span><span class="p">,</span> <span class="n">central_atom_frac_coords_rev</span><span class="p">],</span>  <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">hydrogen_atom_frac_coords_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hydrogen_atom_frac_coords</span><span class="p">,</span> <span class="n">hydrogen_atom_frac_coords_rev</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">contact_atom_frac_coords_pre</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">contact_atom_frac_coords</span><span class="p">,</span> <span class="n">contact_atom_frac_coords_rev</span><span class="p">],</span>  <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 3) Compute Cartesian coords</span>
    <span class="n">central_atom_coords_pre</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">central_atom_frac_coords_pre</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>
    <span class="n">hydrogen_atom_coords_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">hydrogen_atom_frac_coords_pre</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>
    <span class="n">contact_atom_coords_pre</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">contact_atom_frac_coords_pre</span><span class="p">,</span> <span class="n">cell_matrix</span><span class="p">)</span>

    <span class="c1"># 4) Duplicate metrics</span>
    <span class="n">lengths_pre</span>           <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">lengths</span><span class="p">,</span> <span class="n">lengths</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">angles_pre</span>            <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">angles</span><span class="p">,</span> <span class="n">angles</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">in_los_pre</span>            <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">in_los</span><span class="p">,</span> <span class="n">in_los</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">central_atom_idx_pre</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">central_atom_idx</span><span class="p">,</span> <span class="n">contact_atom_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">hydrogen_atom_idx_pre</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">hydrogen_atom_idx</span><span class="p">,</span> <span class="n">hydrogen_atom_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">contact_atom_idx_pre</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">contact_atom_idx</span><span class="p">,</span> <span class="n">central_atom_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 5) Prepare extended symmetry matrices</span>
    <span class="n">symmetry_A_ext</span>     <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">symmetry_A</span><span class="p">,</span> <span class="n">symmetry_A_inv</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">symmetry_T_ext</span>     <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">symmetry_T</span><span class="p">,</span> <span class="n">symmetry_T_inv</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">symmetry_A_inv_ext</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">symmetry_A_inv</span><span class="p">,</span> <span class="n">symmetry_A</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">symmetry_T_inv_ext</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">symmetry_T_inv</span><span class="p">,</span> <span class="n">symmetry_T</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># 6) Allocate zero-padded outputs</span>
    <span class="n">central_atom_frac_coords_ext</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">central_atom_frac_coords_pre</span><span class="p">)</span>
    <span class="n">hydrogen_atom_frac_coords_ext</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hydrogen_atom_frac_coords_pre</span><span class="p">)</span>
    <span class="n">contact_atom_frac_coords_ext</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">contact_atom_frac_coords_pre</span><span class="p">)</span>
    <span class="n">central_atom_coords_ext</span>       <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">central_atom_coords_pre</span><span class="p">)</span>
    <span class="n">hydrogen_atom_coords_ext</span>      <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hydrogen_atom_coords_pre</span><span class="p">)</span>
    <span class="n">contact_atom_coords_ext</span>       <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">contact_atom_coords_pre</span><span class="p">)</span>
    <span class="n">lengths_ext</span>                   <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lengths_pre</span><span class="p">)</span>
    <span class="n">angles_ext</span>                    <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">angles_pre</span><span class="p">)</span>
    <span class="n">in_los_ext</span>                    <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">in_los_pre</span><span class="p">)</span>
    <span class="n">central_atom_idx_ext</span>          <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">central_atom_idx_pre</span><span class="p">)</span>
    <span class="n">hydrogen_atom_idx_ext</span>         <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hydrogen_atom_idx_pre</span><span class="p">)</span>
    <span class="n">contact_atom_idx_ext</span>          <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">contact_atom_idx_pre</span><span class="p">)</span>

    <span class="c1"># 7) Pack valid hbonds first</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
        <span class="n">nC</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">lengths</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">nC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">orig_end</span>  <span class="o">=</span> <span class="n">nC</span>
        <span class="n">rev_start</span> <span class="o">=</span> <span class="n">nC</span>
        <span class="n">rev_end</span>   <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nC</span>

        <span class="c1"># fractional coords</span>
        <span class="n">central_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>          <span class="o">=</span> <span class="n">central_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">central_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>  <span class="o">=</span> <span class="n">central_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">hydrogen_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">hydrogen_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">hydrogen_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">hydrogen_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">contact_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>          <span class="o">=</span> <span class="n">contact_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">contact_atom_frac_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>  <span class="o">=</span> <span class="n">contact_atom_frac_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>

        <span class="c1"># Cartesian coords</span>
        <span class="n">central_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>          <span class="o">=</span> <span class="n">central_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">central_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>  <span class="o">=</span> <span class="n">central_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">hydrogen_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">hydrogen_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">hydrogen_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">hydrogen_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">contact_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>          <span class="o">=</span> <span class="n">contact_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">contact_atom_coords_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>  <span class="o">=</span> <span class="n">contact_atom_coords_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>

        <span class="c1"># metrics</span>
        <span class="n">lengths_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">lengths_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">lengths_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">lengths_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">angles_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>          <span class="o">=</span> <span class="n">angles_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">angles_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>  <span class="o">=</span> <span class="n">angles_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">in_los_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>          <span class="o">=</span> <span class="n">in_los_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">in_los_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>  <span class="o">=</span> <span class="n">in_los_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        
        <span class="c1"># indices</span>
        <span class="n">central_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>          <span class="o">=</span> <span class="n">central_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">central_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>  <span class="o">=</span> <span class="n">central_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">hydrogen_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>         <span class="o">=</span> <span class="n">hydrogen_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">hydrogen_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">hydrogen_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>
        <span class="n">contact_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>          <span class="o">=</span> <span class="n">contact_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">orig_end</span><span class="p">]</span>
        <span class="n">contact_atom_idx_ext</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">rev_start</span><span class="p">:</span><span class="n">rev_end</span><span class="p">]</span>  <span class="o">=</span> <span class="n">contact_atom_idx_pre</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="p">:</span><span class="n">C</span> <span class="o">+</span> <span class="n">nC</span><span class="p">]</span>

    <span class="c1"># 8) Extend label lists</span>
    <span class="n">central_atom_labels_ext</span>  <span class="o">=</span> <span class="p">[</span><span class="n">orig</span> <span class="o">+</span> <span class="n">rev</span> <span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">rev</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">central_atom_label</span><span class="p">,</span> <span class="n">contact_atom_label</span><span class="p">)]</span>
    <span class="n">hydrogen_atom_labels_ext</span> <span class="o">=</span> <span class="p">[</span><span class="n">orig</span> <span class="o">+</span> <span class="n">rev</span> <span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">rev</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hydrogen_atom_label</span><span class="p">,</span> <span class="n">hydrogen_atom_label</span><span class="p">)]</span>
    <span class="n">contact_atom_labels_ext</span>  <span class="o">=</span> <span class="p">[</span><span class="n">orig</span> <span class="o">+</span> <span class="n">rev</span> <span class="k">for</span> <span class="n">orig</span><span class="p">,</span> <span class="n">rev</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">contact_atom_label</span><span class="p">,</span> <span class="n">central_atom_label</span><span class="p">)]</span>
    
    <span class="c1"># 9) Calculate the contact mask</span>
    <span class="n">inter_hb_mask</span> <span class="o">=</span> <span class="n">lengths_ext</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;inter_hb_central_atom&quot;</span><span class="p">:</span>              <span class="n">central_atom_labels_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_hydrogen_atom&quot;</span><span class="p">:</span>             <span class="n">hydrogen_atom_labels_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_contact_atom&quot;</span><span class="p">:</span>              <span class="n">contact_atom_labels_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_central_atom_idx&quot;</span><span class="p">:</span>          <span class="n">central_atom_idx_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_hydrogen_atom_idx&quot;</span><span class="p">:</span>         <span class="n">hydrogen_atom_idx_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_contact_atom_idx&quot;</span><span class="p">:</span>          <span class="n">contact_atom_idx_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_central_atom_coords&quot;</span><span class="p">:</span>       <span class="n">central_atom_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_hydrogen_atom_coords&quot;</span><span class="p">:</span>      <span class="n">hydrogen_atom_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_contact_atom_coords&quot;</span><span class="p">:</span>       <span class="n">contact_atom_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_central_atom_frac_coords&quot;</span><span class="p">:</span>  <span class="n">central_atom_frac_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_hydrogen_atom_frac_coords&quot;</span><span class="p">:</span> <span class="n">hydrogen_atom_frac_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_contact_atom_frac_coords&quot;</span><span class="p">:</span>  <span class="n">contact_atom_frac_coords_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_length&quot;</span><span class="p">:</span>                    <span class="n">lengths_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_angle&quot;</span><span class="p">:</span>                     <span class="n">angles_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_in_los&quot;</span><span class="p">:</span>                    <span class="n">in_los_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_symmetry_A&quot;</span><span class="p">:</span>                <span class="n">symmetry_A_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_symmetry_T&quot;</span><span class="p">:</span>                <span class="n">symmetry_T_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_symmetry_A_inv&quot;</span><span class="p">:</span>            <span class="n">symmetry_A_inv_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_symmetry_T_inv&quot;</span><span class="p">:</span>            <span class="n">symmetry_T_inv_ext</span><span class="p">,</span>
        <span class="s2">&quot;inter_hb_mask&quot;</span><span class="p">:</span>                      <span class="n">inter_hb_mask</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="compute_contact_is_hbond">
<a class="viewcode-back" href="../api/contact_utils.html#contact_utils.compute_contact_is_hbond">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_contact_is_hbond</span><span class="p">(</span>
        <span class="n">cc_central_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">cc_contact_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">cc_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">hb_central_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">hb_hydrogen_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">hb_contact_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">hb_mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flag which contacts correspond to hydrogen bonds.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cc_central_idx : torch.LongTensor, shape (B, C)</span>
<span class="sd">        Central-atom indices for each intermolecular contact.</span>
<span class="sd">    cc_contact_idx : torch.LongTensor, shape (B, C)</span>
<span class="sd">        Contact-atom indices for each intermolecular contact.</span>
<span class="sd">    cc_mask : torch.BoolTensor, shape (B, C)</span>
<span class="sd">        Validity mask for contacts.</span>
<span class="sd">    hb_central_idx : torch.LongTensor, shape (B, H)</span>
<span class="sd">        Donor-atom indices for each H-bond.</span>
<span class="sd">    hb_hydrogen_idx : torch.LongTensor, shape (B, H)</span>
<span class="sd">        Hydrogen-atom indices for each H-bond.</span>
<span class="sd">    hb_contact_idx : torch.LongTensor, shape (B, H)</span>
<span class="sd">        Acceptor-atom indices for each H-bond.</span>
<span class="sd">    hb_mask : torch.BoolTensor, shape (B, H)</span>
<span class="sd">        Validity mask for H-bonds.</span>
<span class="sd">    device : torch.device</span>
<span class="sd">        Device on which to perform computations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    torch.BoolTensor, shape (B, C)</span>
<span class="sd">        True where each contact participates in any hydrogen-bond triplet.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># move everything onto the same device</span>
    <span class="n">cc_central_idx</span> <span class="o">=</span> <span class="n">cc_central_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">cc_contact_idx</span> <span class="o">=</span> <span class="n">cc_contact_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">cc_mask</span>        <span class="o">=</span> <span class="n">cc_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">hb_central_idx</span> <span class="o">=</span> <span class="n">hb_central_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">hb_hydrogen_idx</span><span class="o">=</span> <span class="n">hb_hydrogen_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">hb_contact_idx</span> <span class="o">=</span> <span class="n">hb_contact_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">hb_mask</span>        <span class="o">=</span> <span class="n">hb_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># shapes</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">C_max</span> <span class="o">=</span> <span class="n">cc_central_idx</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">H_max</span> <span class="o">=</span> <span class="n">hb_central_idx</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># prepare for broadcasting</span>
    <span class="n">cc_c</span> <span class="o">=</span> <span class="n">cc_central_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c1"># (B, C_max, 1)</span>
    <span class="n">cc_p</span> <span class="o">=</span> <span class="n">cc_contact_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="c1"># (B, C_max, 1)</span>
    <span class="n">hb_c</span> <span class="o">=</span> <span class="n">hb_central_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># (B, 1, H_max)</span>
    <span class="n">hb_h</span> <span class="o">=</span> <span class="n">hb_hydrogen_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="c1"># (B, 1, H_max)</span>
    <span class="n">hb_p</span> <span class="o">=</span> <span class="n">hb_contact_idx</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="c1"># (B, 1, H_max)</span>
    <span class="n">hb_m</span> <span class="o">=</span> <span class="n">hb_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>           <span class="c1"># (B, 1, H_max)</span>

    <span class="c1"># 1) heavy‐heavy matches</span>
    <span class="n">hh_match</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc_c</span> <span class="o">==</span> <span class="n">hb_c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cc_p</span> <span class="o">==</span> <span class="n">hb_p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hb_m</span>
    <span class="n">hh_flag</span>  <span class="o">=</span> <span class="n">hh_match</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cc_mask</span>

    <span class="c1"># 2) donor‐to‐H matches</span>
    <span class="n">d2h_match</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc_c</span> <span class="o">==</span> <span class="n">hb_c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cc_p</span> <span class="o">==</span> <span class="n">hb_h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hb_m</span>
    <span class="n">d2h_flag</span>  <span class="o">=</span> <span class="n">d2h_match</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cc_mask</span>

    <span class="c1"># 3) H‐to‐acceptor matches</span>
    <span class="n">h2a_match</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc_c</span> <span class="o">==</span> <span class="n">hb_h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cc_p</span> <span class="o">==</span> <span class="n">hb_p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hb_m</span>
    <span class="n">h2a_flag</span>  <span class="o">=</span> <span class="n">h2a_match</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cc_mask</span>

    <span class="c1"># combine all three conditions</span>
    <span class="n">hb_flags</span> <span class="o">=</span> <span class="n">hh_flag</span> <span class="o">|</span> <span class="n">d2h_flag</span> <span class="o">|</span> <span class="n">h2a_flag</span>

    <span class="k">return</span> <span class="n">hb_flags</span></div>


<div class="viewcode-block" id="compute_contact_fragment_indices_batch">
<a class="viewcode-back" href="../api/contact_utils.html#contact_utils.compute_contact_fragment_indices_batch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_contact_fragment_indices_batch</span><span class="p">(</span>
        <span class="n">central_atom_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>   <span class="c1"># (B, C) atom‐index of the central atom for each contact, -1 if none</span>
        <span class="n">contact_atom_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>   <span class="c1"># (B, C) atom‐index of the other atom in each contact,   -1 if none</span>
        <span class="n">atom_fragment_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span>  <span class="c1"># (B, N) fragment ID per atom</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map contact atom indices to fragment IDs.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    central_atom_idx : torch.LongTensor, shape (B, C)</span>
<span class="sd">        Central-atom indices for each contact, or –1 for padding.</span>
<span class="sd">    contact_atom_idx : torch.LongTensor, shape (B, C)</span>
<span class="sd">        Contact-atom indices for each contact, or –1 for padding.</span>
<span class="sd">    atom_fragment_ids : torch.LongTensor, shape (B, N)</span>
<span class="sd">        Fragment ID assigned to each atom.</span>
<span class="sd">    device : torch.device</span>
<span class="sd">        Device on which to perform computations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        {</span>
<span class="sd">          &#39;inter_cc_central_atom_fragment_idx&#39;: torch.LongTensor, shape (B, C),</span>
<span class="sd">          &#39;inter_cc_contact_atom_fragment_idx&#39;: torch.LongTensor, shape (B, C)</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1) Move to device and ensure int64</span>
    <span class="n">centr</span> <span class="o">=</span> <span class="n">central_atom_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>     <span class="c1"># now int64</span>
    <span class="n">cont</span>  <span class="o">=</span> <span class="n">contact_atom_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">frag</span>  <span class="o">=</span> <span class="n">atom_fragment_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>    <span class="c1"># ensure int64</span>

    <span class="n">B</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">centr</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># 2) clamp into valid range [0, N-1] to avoid out-of-bounds</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">max_i</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((),</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">centr_clamped</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">centr</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">max_i</span><span class="p">)</span>
    <span class="n">cont_clamped</span>  <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">cont</span><span class="p">,</span>  <span class="n">zero</span><span class="p">,</span> <span class="n">max_i</span><span class="p">)</span>

    <span class="c1"># 3) gather fragment IDs</span>
    <span class="n">central_frag_idx</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">centr_clamped</span><span class="p">)</span>  <span class="c1"># (B, C)</span>
    <span class="n">contact_frag_idx</span> <span class="o">=</span> <span class="n">frag</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cont_clamped</span><span class="p">)</span>   <span class="c1"># (B, C)</span>

    <span class="c1"># 4) restore “–1” where original index was negative</span>
    <span class="n">central_frag_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">centr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">central_frag_idx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                                   <span class="n">central_frag_idx</span><span class="p">)</span>
    <span class="n">contact_frag_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cont</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
                                   <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">contact_frag_idx</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                                   <span class="n">contact_frag_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span> 
        <span class="s1">&#39;inter_cc_central_atom_fragment_idx&#39;</span><span class="p">:</span> <span class="n">central_frag_idx</span><span class="p">,</span> 
        <span class="s1">&#39;inter_cc_contact_atom_fragment_idx&#39;</span> <span class="p">:</span> <span class="n">contact_frag_idx</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="compute_contact_atom_to_central_fragment_com_batch">
<a class="viewcode-back" href="../api/contact_utils.html#contact_utils.compute_contact_atom_to_central_fragment_com_batch">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_contact_atom_to_central_fragment_com_batch</span><span class="p">(</span>
        <span class="n">inter_cc_contact_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>       <span class="c1"># (B, C_max, 3)</span>
        <span class="n">inter_cc_contact_frac_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>  <span class="c1"># (B, C_max, 3)</span>
        <span class="n">central_frag_idx</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>              <span class="c1"># (B, Cc), int or long, –1 for padding</span>
        <span class="n">fragment_com_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>           <span class="c1"># (F_total, 3)</span>
        <span class="n">fragment_com_frac_coords</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>      <span class="c1"># (F_total, 3)</span>
        <span class="n">struct_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>                    <span class="c1"># (F_total,), long</span>
        <span class="n">fragment_local_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>            <span class="c1"># (F_total,), long</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute vectors and distances from contact atoms to central-fragment center of mass.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inter_cc_contact_coords : torch.Tensor, shape (B, C, 3)</span>
<span class="sd">        Cartesian coordinates of contact atoms.</span>
<span class="sd">    inter_cc_contact_frac_coords : torch.Tensor, shape (B, C, 3)</span>
<span class="sd">        Fractional coordinates of contact atoms.</span>
<span class="sd">    central_frag_idx : torch.LongTensor, shape (B, C)</span>
<span class="sd">        Fragment IDs of central atoms for each contact.</span>
<span class="sd">    fragment_com_coords : torch.Tensor, shape (F_total, 3)</span>
<span class="sd">        Cartesian COM coordinates for all fragments.</span>
<span class="sd">    fragment_com_frac_coords : torch.Tensor, shape (F_total, 3)</span>
<span class="sd">        Fractional COM coordinates for all fragments.</span>
<span class="sd">    struct_ids : torch.Tensor, shape (F_total,)</span>
<span class="sd">        Structure IDs corresponding to each fragment.</span>
<span class="sd">    fragment_local_ids : torch.Tensor, shape (F_total,)</span>
<span class="sd">        Local fragment indices within each structure.</span>
<span class="sd">    device : torch.device</span>
<span class="sd">        Device on which to perform computations.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        {</span>
<span class="sd">          &#39;inter_cc_contact_atom_to_fragment_com_vec&#39;: torch.Tensor, shape (B, C, 3),</span>
<span class="sd">          &#39;inter_cc_contact_atom_to_fragment_com_frac_vec&#39;: torch.Tensor, shape (B, C, 3),</span>
<span class="sd">          &#39;inter_cc_contact_atom_to_fragment_com_dist&#39;: torch.Tensor, shape (B, C),</span>
<span class="sd">          &#39;inter_cc_contact_atom_to_fragment_com_frac_dist&#39;: torch.Tensor, shape (B, C)</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1) move inputs to device and ensure int64 for indices</span>
    <span class="n">coords_cart</span> <span class="o">=</span> <span class="n">inter_cc_contact_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">coords_frac</span> <span class="o">=</span> <span class="n">inter_cc_contact_frac_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">centr_idx</span>   <span class="o">=</span> <span class="n">central_frag_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">com_cart</span>    <span class="o">=</span> <span class="n">fragment_com_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># ensure float dtype</span>
    <span class="n">com_frac</span>    <span class="o">=</span> <span class="n">fragment_com_frac_coords</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">s_ids</span>       <span class="o">=</span> <span class="n">struct_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="n">local_ids</span>   <span class="o">=</span> <span class="n">fragment_local_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>

    <span class="n">B</span><span class="p">,</span> <span class="n">C_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">coords_cart</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">F_total</span>     <span class="o">=</span> <span class="n">com_cart</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># 2) pad central‐fragment indices to C_max columns if needed</span>
    <span class="k">if</span> <span class="n">centr_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">C_max</span><span class="p">:</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">B</span><span class="p">,</span> <span class="n">C_max</span> <span class="o">-</span> <span class="n">centr_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">centr_full</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">centr_idx</span><span class="p">,</span> <span class="n">pad</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">centr_full</span> <span class="o">=</span> <span class="n">centr_idx</span>

    <span class="c1"># 3) build a flattened lookup table of size B * n_frags_max</span>
    <span class="c1">#    so that lookup_flat[b * n_frags_max + local_id] = global_row_index</span>
    <span class="n">n_frags_per_struct</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">s_ids</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">B</span><span class="p">)</span>            <span class="c1"># (B,)</span>
    <span class="n">n_frags_max</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_frags_per_struct</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

    <span class="n">lookup_flat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">B</span> <span class="o">*</span> <span class="n">n_frags_max</span><span class="p">,),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">fragment_rows</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">F_total</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>  <span class="c1"># (F_total,)</span>
    <span class="n">idx_flat</span> <span class="o">=</span> <span class="n">s_ids</span> <span class="o">*</span> <span class="n">n_frags_max</span> <span class="o">+</span> <span class="n">local_ids</span>                             <span class="c1"># (F_total,)</span>
    <span class="n">lookup_flat</span> <span class="o">=</span> <span class="n">lookup_flat</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idx_flat</span><span class="p">,</span> <span class="n">fragment_rows</span><span class="p">)</span>
    <span class="n">lookup</span> <span class="o">=</span> <span class="n">lookup_flat</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">n_frags_max</span><span class="p">)</span>  <span class="c1"># (B, n_frags_max)</span>

    <span class="c1"># 4) for each contact, get the global fragment‐COM row index</span>
    <span class="c1">#    clamp to [0, n_frags_max-1] to avoid OOB, will mask out invalid entries later</span>
    <span class="n">local_clamped</span> <span class="o">=</span> <span class="n">centr_full</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">n_frags_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, C_max)</span>
    <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C_max</span><span class="p">)</span>  <span class="c1"># (B, C_max)</span>
    <span class="n">com_row_idx</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">local_clamped</span><span class="p">]</span>  <span class="c1"># (B, C_max), values in [-1, F_total-1]</span>

    <span class="c1"># 5) clamp to valid fragment rows for indexing COM coords</span>
    <span class="n">safe_rows</span> <span class="o">=</span> <span class="n">com_row_idx</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">F_total</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, C_max)</span>

    <span class="c1"># 6) gather the actual COM coordinates per contact</span>
    <span class="n">point_cart</span> <span class="o">=</span> <span class="n">com_cart</span><span class="p">[</span><span class="n">safe_rows</span><span class="p">]</span>   <span class="c1"># (B, C_max, 3)</span>
    <span class="n">point_frac</span> <span class="o">=</span> <span class="n">com_frac</span><span class="p">[</span><span class="n">safe_rows</span><span class="p">]</span>   <span class="c1"># (B, C_max, 3)</span>

    <span class="c1"># 7) mask for valid contacts, zero out padded ones</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">centr_full</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>                     <span class="c1"># (B, C_max)</span>
    <span class="n">mask3</span> <span class="o">=</span> <span class="n">valid_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coords_cart</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>  <span class="c1"># (B, C_max, 1)</span>

    <span class="c1"># 8) compute displacement vectors and distances</span>
    <span class="n">vecs_cart</span> <span class="o">=</span> <span class="p">(</span><span class="n">coords_cart</span> <span class="o">-</span> <span class="n">point_cart</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask3</span>
    <span class="n">vecs_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">coords_frac</span> <span class="o">-</span> <span class="n">point_frac</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask3</span>

    <span class="n">dists_cart</span> <span class="o">=</span> <span class="n">vecs_cart</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, C_max)</span>
    <span class="n">dists_frac</span> <span class="o">=</span> <span class="n">vecs_frac</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (B, C_max)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;inter_cc_contact_atom_to_fragment_com_dist&#39;</span><span class="p">:</span>      <span class="n">dists_cart</span><span class="p">,</span> 
        <span class="s1">&#39;inter_cc_contact_atom_to_fragment_com_frac_dist&#39;</span><span class="p">:</span> <span class="n">dists_frac</span><span class="p">,</span> 
        <span class="s1">&#39;inter_cc_contact_atom_to_fragment_com_vec&#39;</span><span class="p">:</span>       <span class="n">vecs_cart</span><span class="p">,</span> 
        <span class="s1">&#39;inter_cc_contact_atom_to_fragment_com_frac_vec&#39;</span><span class="p">:</span>  <span class="n">vecs_frac</span>
        <span class="p">}</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Nikolaos Galanakis.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>